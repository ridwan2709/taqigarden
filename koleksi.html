<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koleksi Tanaman - Taqi Garden</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;600&display=swap');

        :root {
            --primary-green: #2d4a3e;
            --accent-green: #4f7962;
            --cream: #f9f7f2;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cream);
            color: #333;
        }

        h1, h2, h3, .brand-font {
            font-family: 'Playfair Display', serif;
        }

        .product-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .filter-btn.active {
            background-color: var(--primary-green);
            color: white;
        }

        .whatsapp-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #25d366;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 2px 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        /* Modal Styles */
        #adminModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <!-- Tombol WhatsApp -->
    <a href="https://wa.me/6281234567890?text=Halo%20Taqi%20Garden,%20saya%20ingin%20tanya%20stok%20tanaman." target="_blank" class="whatsapp-btn">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Navbar -->
    <header class="bg-white/90 backdrop-blur-md sticky top-0 z-50 border-b border-gray-100">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <div class="flex flex-col leading-none">
                    <span class="text-2xl font-bold text-[#2d4a3e] tracking-tighter brand-font">TAQI</span>
                    <span class="text-xs tracking-[0.3em] font-semibold text-gray-500 uppercase">Garden</span>
                </div>
            </a>
            <ul class="hidden md:flex space-x-8 text-sm font-medium uppercase tracking-widest text-gray-700">
                <li><a href="index.html" class="hover:text-[#4f7962]">Beranda</a></li>
                <li><a href="#" class="text-[#4f7962]">Koleksi</a></li>
                <li><a href="index.html#about" class="hover:text-[#4f7962]">Tentang Kami</a></li>
            </ul>
            <div class="flex items-center space-x-5">
                <button onclick="openAdmin()" class="text-gray-400 hover:text-[#2d4a3e] transition">
                    <i class="fas fa-plus-circle text-xl"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- Page Header -->
    <section class="bg-[#2d4a3e] py-16 text-center text-white">
        <h1 class="text-4xl md:text-5xl mb-4">Semua Koleksi Kami</h1>
        <p class="opacity-80 max-w-2xl mx-auto px-6">Temukan berbagai pilihan tanaman hias terbaik untuk melengkapi keasrian rumah Anda.</p>
    </section>

    <!-- Products Section -->
    <section class="py-12">
        <div class="container mx-auto px-6">
            
            <!-- Filter & Search -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
                <div class="flex flex-wrap justify-center gap-3" id="filterContainer">
                    <button class="filter-btn active px-6 py-2 rounded-full border border-[#2d4a3e] text-sm uppercase tracking-wider transition" onclick="filterProducts('semua')">Semua</button>
                    <button class="filter-btn px-6 py-2 rounded-full border border-[#2d4a3e] text-sm uppercase tracking-wider transition" onclick="filterProducts('indoor')">Indoor</button>
                    <button class="filter-btn px-6 py-2 rounded-full border border-[#2d4a3e] text-sm uppercase tracking-wider transition" onclick="filterProducts('langka')">Langka</button>
                    <button class="filter-btn px-6 py-2 rounded-full border border-[#2d4a3e] text-sm uppercase tracking-wider transition" onclick="filterProducts('sukulen')">Sukulen</button>
                </div>
                <div class="relative w-full md:w-64">
                    <input type="text" id="searchInput" placeholder="Cari tanaman..." class="w-full pl-10 pr-4 py-2 border-b border-gray-300 bg-transparent focus:outline-none focus:border-[#2d4a3e]">
                    <i class="fas fa-search absolute left-2 top-3 text-gray-400"></i>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loading" class="text-center py-20 text-[#2d4a3e]">
                <i class="fas fa-circle-notch fa-spin text-4xl"></i>
                <p class="mt-4">Memuat koleksi...</p>
            </div>

            <!-- Product Grid -->
            <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                <!-- Produk akan dimuat melalui Firebase -->
            </div>
        </div>
    </section>

    <!-- Admin Modal (Tambah Produk) -->
    <div id="adminModal">
        <div class="bg-white p-8 rounded-2xl w-full max-w-md mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold brand-font text-[#2d4a3e]">Tambah Tanaman</h3>
                <button onclick="closeAdmin()" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <form id="addPlantForm" class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-widest text-gray-500 mb-1">Nama Tanaman</label>
                    <input type="text" id="pName" required class="w-full border p-2 rounded focus:ring-2 focus:ring-[#2d4a3e] outline-none">
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-widest text-gray-500 mb-1">Kategori</label>
                    <select id="pCategory" class="w-full border p-2 rounded outline-none">
                        <option value="indoor">Indoor</option>
                        <option value="langka">Langka</option>
                        <option value="sukulen">Sukulen</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-widest text-gray-500 mb-1">Harga (Tanpa Rp)</label>
                    <input type="text" id="pPrice" placeholder="e.g. 150.000" required class="w-full border p-2 rounded outline-none">
                </div>
                <div>
                    <label class="block text-xs uppercase tracking-widest text-gray-500 mb-1">URL Gambar (Unsplash/Lainnya)</label>
                    <input type="url" id="pImg" placeholder="https://..." required class="w-full border p-2 rounded outline-none">
                </div>
                <button type="submit" class="w-full bg-[#2d4a3e] text-white py-3 rounded-lg hover:bg-[#4f7962] transition font-bold uppercase tracking-widest">Simpan Koleksi</button>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-[#2d4a3e] text-white py-12 mt-20">
        <div class="container mx-auto px-6 text-center">
            <div class="brand-font text-3xl mb-4">TAQI Garden</div>
            <p class="text-gray-400 text-sm mb-8">Kualitas terbaik, pengiriman aman, hati yang tenang.</p>
            <p class="text-xs text-gray-500">&copy; 2026 Taqi Garden Indonesia. Semua Hak Dilindungi.</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA51F2pPZUWmdOaYqsihD78LTrvnXDqXn4",
            authDomain: "taqi-4a756.firebaseapp.com",
            projectId: "taqi-4a756",
            storageBucket: "taqi-4a756.firebasestorage.app",
            messagingSenderId: "836265831490",
            appId: "1:836265831490:web:38277600db742f145451db",
            measurementId: "G-0TJDCT97CN"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'taqi-garden-app';

        let allProducts = [];

        // 1. Auth & Initial Load (Mengikuti Rule 3: Auth Dulu Baru Query)
        const init = async () => {
            try {
                console.log('Starting authentication...');
                
                // Try anonymous authentication first
                try {
                    console.log('Attempting anonymous sign-in...');
                    const userCredential = await signInAnonymously(auth);
                    console.log('Anonymous sign-in successful:', userCredential.user.uid);
                } catch (authError) {
                    console.error('Anonymous auth failed, trying custom token...', authError);
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        console.log('Attempting custom token sign-in...');
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        throw new Error('No authentication method available');
                    }
                }
                
                // Set up auth state listener
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log('Auth state changed - User signed in:', user.uid);
                        loadData();
                    } else {
                        console.log('Auth state changed - No user signed in');
                        document.getElementById('loading').innerHTML = "Gagal autentikasi. Silakan muat ulang halaman.";
                    }
                    unsubscribe(); // Clean up the listener after it's used
                });
                
            } catch (error) {
                console.error("Autentikasi gagal:", error);
                const errorMessage = error.code || error.message;
                document.getElementById('loading').innerHTML = `
                    <div class="text-red-600">
                        <p class="font-bold">Gagal memuat data</p>
                        <p class="text-sm">${errorMessage}</p>
                        <button onclick="window.location.reload()" class="mt-2 px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200">
                            Coba Lagi
                        </button>
                    </div>`;
            }
        };

        // 2. Load Data from Firestore (Rule 1: Path Spesifik)
        const loadData = () => {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'plants');
            onSnapshot(colRef, (snapshot) => {
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                document.getElementById('loading').style.display = 'none';
                displayProducts(allProducts);
            }, (error) => {
                console.error("Gagal mengambil data", error);
            });
        };

        // 3. Tampilan Koleksi
        window.displayProducts = (filteredList) => {
            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = '';
            
            if (filteredList.length === 0) {
                productGrid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">Belum ada koleksi ditemukan.</div>';
                return;
            }

            filteredList.forEach(product => {
                const card = `
                    <div class="product-card bg-white p-4 rounded-xl shadow-sm border border-gray-50">
                        <div class="aspect-square bg-gray-100 mb-4 overflow-hidden rounded-lg">
                            <img src="${product.img}" alt="${product.name}" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1545241047-6083a3684587?w=500'">
                        </div>
                        <span class="text-[10px] uppercase tracking-widest text-gray-400">${product.category}</span>
                        <h4 class="text-lg font-semibold mb-1">${product.name}</h4>
                        <p class="text-[#4f7962] font-bold mb-4">Rp ${product.price}</p>
                        <a href="https://wa.me/6281234567890?text=Halo%20Taqi%20Garden,%20apakah%20stok%20${product.name}%20masih%20ada?" target="_blank" class="block w-full text-center bg-[#2d4a3e] text-white py-2 rounded-lg hover:bg-[#4f7962] transition text-sm">Tanya Stok</a>
                    </div>
                `;
                productGrid.innerHTML += card;
            });
        };

        // 4. Logika Tambah Tanaman
        const addForm = document.getElementById('addPlantForm');
        addForm.onsubmit = async (e) => {
            e.preventDefault();
            if (!auth.currentUser) return;

            const btn = e.target.querySelector('button');
            btn.innerText = "Menyimpan...";
            btn.disabled = true;

            const newPlant = {
                name: document.getElementById('pName').value,
                category: document.getElementById('pCategory').value,
                price: document.getElementById('pPrice').value,
                img: document.getElementById('pImg').value,
                createdAt: new Date().toISOString()
            };

            try {
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'plants');
                await addDoc(colRef, newPlant);
                addForm.reset();
                closeAdmin();
                // Custom UI Modal sebagai pengganti alert() sesuai panduan
                console.log("Tanaman berhasil disimpan!");
            } catch (err) {
                console.error("Gagal menyimpan:", err);
            } finally {
                btn.innerText = "Simpan Koleksi";
                btn.disabled = false;
            }
        };

        // 5. Pencarian & Filter
        window.filterProducts = (category) => {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText.toLowerCase() === category.toLowerCase()) btn.classList.add('active');
            });
            const filtered = category === 'semua' ? allProducts : allProducts.filter(p => p.category === category);
            displayProducts(filtered);
        };

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(term));
            displayProducts(filtered);
        });

        // Kontrol Modal Admin
        window.openAdmin = () => document.getElementById('adminModal').style.display = 'flex';
        window.closeAdmin = () => document.getElementById('adminModal').style.display = 'none';

        init();
        function setupFormHandlers() {
    const addPlantForm = document.getElementById('addPlantForm');
    if (!addPlantForm) return;
    // Remove any existing event listeners
    const newForm = addPlantForm.cloneNode(true);
    addPlantForm.parentNode.replaceChild(newForm, addPlantForm);
    // Add a single event listener
    newForm.addEventListener('submit', handleFormSubmit);
}
async function handleFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    
    // Prevent multiple submissions
    if (form.dataset.submitting === 'true') return;
    form.dataset.submitting = 'true';
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    
    try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
        
        // Get form values
        const plantData = {
            name: document.getElementById('pName')?.value?.trim(),
            category: document.getElementById('pCategory')?.value,
            price: parseInt(document.getElementById('pPrice')?.value?.replace(/\D/g, '') || '0'),
            imageUrl: document.getElementById('pImg')?.value?.trim(),
            createdAt: new Date().toISOString()
        };
        // Validate required fields
        if (!plantData.name || !plantData.imageUrl) {
            throw new Error('Nama tanaman dan URL gambar harus diisi');
        }
        // Add to Firestore
        const docRef = await addDoc(
            collection(db, 'artifacts/taqi-4a756/public/data/plants'), 
            plantData
        );
        
        console.log('Document written with ID: ', docRef.id);
        form.reset();
        document.getElementById('addPlantModal').classList.add('hidden');
        
    } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'Gagal menambahkan tanaman. Silakan coba lagi.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
        form.dataset.submitting = 'false';
    }
}
// Call this when initializing your page
function initializeCollectionPage() {
    setupFormHandlers();
    // ... rest of your initialization code ...
}
    </script>
</body>
</html>