<!-- articles Section -->
<section class="py-6">
    <div class="container mx-auto">
        <!-- Filter & Search -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
           <div class="relative" id="filterContainer">
                <button id="filterButton" 
                        class="flex items-center gap-2 px-4 py-2 border border-[#2d4a3e] rounded-lg text-[#2d4a3e] hover:bg-[#2d4a3e] hover:text-white transition-colors">
                    <i class="fas fa-filter"></i>
                    <span>Filter</span>
                </button>
                
                <!-- Dropdown Menu -->
                <div id="filterDropdown" 
                    class="hidden absolute z-10 mt-2 w-48 bg-white rounded-md shadow-lg py-1">
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" 
                    onclick="filterarticles('semua'); return false;">
                        <i class="fas fa-th-large mr-2 w-5 text-center"></i> Semua
                    </a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                    onclick="filterarticles('taman'); return false;">
                        <i class="fas fa-tree mr-2 w-5 text-center"></i> Taman
                    </a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                    onclick="filterarticles('langka'); return false;">
                        <i class="fas fa-seedling mr-2 w-5 text-center"></i> Langka
                    </a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                    onclick="filterarticles('sukulen'); return false;">
                        <i class="fas fa-leaf mr-2 w-5 text-center"></i> Sukulen
                    </a>
                </div>
            </div>
            <div class="relative w-full md:w-64">
                <input type="text" id="searchInput" placeholder="Cari tanaman..." 
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2d4a3e] focus:border-transparent outline-none text-sm">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="text-center py-20 text-[#2d4a3e]">
            <i class="fas fa-circle-notch fa-spin text-4xl"></i>
            <p class="mt-4">Memuat koleksi...</p>
        </div>

        <!-- article Grid -->
        <div id="articleGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
            <!-- articles will be loaded here -->
        </div>

        <!-- Pagination -->
        <div class="flex justify-center mt-8">
            <nav class="flex items-center space-x-1">
                <button id="firstPage" class="pagination-btn" disabled>
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button id="prevPage" class="pagination-btn" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="pageNumbers" class="flex items-center space-x-1">
                    <!-- Page numbers will be inserted here -->
                </div>
                <button id="nextPage" class="pagination-btn">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button id="lastPage" class="pagination-btn">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </nav>
        </div>
    </div>
</section>

<!-- Add Article Button (Floating) -->
<button id="addArticleBtn" class="fixed bottom-8 right-8 bg-[#2d4a3e] text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:bg-[#4f7962] transition-transform hover:scale-105">
    <i class="fas fa-plus text-xl"></i>
</button>

<!-- Add/Edit Article Modal -->
<div id="addArticleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden overflow-y-auto">
    <div class="bg-white rounded-2xl w-full max-w-3xl mx-8 shadow-2xl my-8">
        <div class="flex justify-between items-center p-6 border-b">
            <h3 class="text-xl font-bold brand-font text-[#2d4a3e]" id="modalTitle">Tambah Artikel Baru</h3>
            <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <form id="addArticleForm" class="p-6 space-y-4 max-h-[80vh] overflow-y-auto">
            <div class="space-y-4">
                <!-- Judul Artikel -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Judul Artikel</label>
                    <input type="text" id="articleTitle" required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2d4a3e] focus:border-transparent outline-none"
                        placeholder="Masukkan judul artikel">
                </div>
                
                <!-- Gambar Artikel -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gambar Utama</label>
                    <div class="mt-1 flex items-center">
                        <div class="w-full
                            border-2 border-dashed border-gray-300
                            rounded-lg p-4 text-center
                            hover:border-[#2d4a3e] transition-colors
                            cursor-pointer"
                            id="imageUploadArea">
                            <input type="file" id="articleImage" accept="image/*" class="hidden">
                            <div id="imagePreview" class="mt-2 flex justify-center">
                                <div class="text-center">
                                    <i class="fas fa-image text-4xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500">Klik untuk mengunggah gambar</p>
                                    <p class="text-xs text-gray-400">Rekomendasi: 800x450px (16:9)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p id="imageError" class="mt-1 text-sm text-red-600 hidden"></p>
                </div>

                <!-- Kategori -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select id="articleCategory" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2d4a3e] focus:border-transparent outline-none">
                        <option value="">Pilih Kategori</option>
                        <option value="perawatan">Perawatan Tanaman</option>
                        <option value="taman">Desain Taman</option>
                        <option value="hama">Pengendalian Hama</option>
                        <option value="tips">Tips & Trik</option>
                        <option value="sukulen">Sukulen</option>
                        <option value="hias">Tanaman Hias</option>
                    </select>
                </div>
                
                <!-- Isi Artikel -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Isi Artikel</label>
                    <textarea id="articleContent" rows="10" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2d4a3e] focus:border-transparent outline-none"
                        placeholder="Tulis isi artikel di sini..."></textarea>
                </div>
                
                <!-- Tombol Aksi -->
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="submit" class="px-6 py-2 bg-[#2d4a3e] text-white rounded-lg hover:bg-[#1f3a30] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#2d4a3e]">
                        <i class="fas fa-save mr-2"></i> Simpan Artikel
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { 
        getFirestore, collection, addDoc, query, orderBy, 
        onSnapshot, deleteDoc, doc, updateDoc 
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js';
    
    const firebaseConfig = {
        apiKey: "AIzaSyA51F2pPZUWmdOaYqsihD78LTrvnXDqXn4",
        authDomain: "taqi-4a756.firebaseapp.com",
        projectId: "taqi-4a756",
        storageBucket: "taqi-4a756.firebasestorage.app",
        messagingSenderId: "836265831490",
        appId: "1:836265831490:web:38277600db742f145451db"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    const storage = getStorage(app);
    
    // Path koleksi (sesuai kode Anda: atricles)
    const COLLECTION_PATH = 'artifacts/taqi-4a756/public/data/atricles';

    let currentEditingId = null;
    let articles = [];
    let filteredArticles = [];
    let currentPage = 1;
    const itemsPerPage = 8;

    // --- Core Functions ---

    function setupAuthListener() {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadArticles();
                setupFormHandlers();
                setupModalHandlers();
                setupPagination();
            } else {
                window.location.href = 'login.html';
            }
        });
    }

    function loadArticles() {
        const loadingElement = document.getElementById('loading');
        const q = query(collection(db, COLLECTION_PATH), orderBy('createdAt', 'desc'));
        
        onSnapshot(q, (snapshot) => {
            articles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            filteredArticles = [...articles];
            if (loadingElement) loadingElement.classList.add('hidden');
            renderCurrentPage();
            updatePaginationUI();
            initializeSearch();
        });
    }

    function renderArticles(data) {
        const grid = document.getElementById('articleGrid');
        if (!grid) return;

        if (data.length === 0) {
            grid.innerHTML = `<div class="col-span-full text-center py-12 text-gray-500"><p>Tidak ada artikel ditemukan.</p></div>`;
            return;
        }

        grid.innerHTML = data.map(article => `
            <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-all relative group">
                <div class="absolute top-2 right-2 flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                    <button onclick="editArticle('${article.id}')" class="bg-white p-2 rounded-full text-blue-600 shadow"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteArticle('${article.id}')" class="bg-white p-2 rounded-full text-red-600 shadow"><i class="fas fa-trash"></i></button>
                </div>
                <div class="h-48 overflow-hidden">
                    <img src="${article.imageUrl || 'img/placeholder.jpg'}" class="w-full h-full object-cover">
                </div>
                <div class="p-4">
                    <span class="px-2 py-1 text-xs font-bold text-white bg-green-500 rounded-full">${article.category}</span>
                    <h3 class="font-bold mt-2">${article.title}</h3>
                </div>
            </div>
        `).join('');
    }

    // --- Image Upload Handler ---
    let articleImageUrl = '';
    
    document.getElementById('imageUploadArea').addEventListener('click', function() {
        document.getElementById('articleImage').click();
    });

    document.getElementById('articleImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validasi ukuran file (maks 2MB)
        if (file.size > 2 * 1024 * 1024) {
            document.getElementById('imageError').textContent = 'Ukuran file maksimal 2MB';
            document.getElementById('imageError').classList.remove('hidden');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.innerHTML = `
                <div class="relative w-full">
                    <img src="${e.target.result}" alt="Preview" class="max-h-48 mx-auto rounded-lg">
                    <button type="button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center" 
                            onclick="event.stopPropagation(); document.getElementById('articleImage').value = ''; 
                                     articleImageUrl = ''; 
                                     document.getElementById('imagePreview').innerHTML = `
                                         <div class='text-center'>
                                             <i class='fas fa-image text-4xl text-gray-400 mb-2'></i>
                                             <p class='text-sm text-gray-500'>Klik untuk mengunggah gambar</p>
                                             <p class='text-xs text-gray-400'>Rekomendasi: 800x450px (16:9)</p>
                                         </div>`;">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>`;
            document.getElementById('imageError').classList.add('hidden');
        };
        reader.readAsDataURL(file);

        // Upload image to server
        const formData = new FormData();
        formData.append('articleImage', file);

        fetch('upload_article.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                articleImageUrl = data.imageUrl;
            } else {
                document.getElementById('imageError').textContent = data.message || 'Gagal mengunggah gambar';
                document.getElementById('imageError').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('imageError').textContent = 'Terjadi kesalahan saat mengunggah gambar';
            document.getElementById('imageError').classList.remove('hidden');
        });
    });

    // --- Action Handlers ---

    window.editArticle = function(id) {
        const article = articles.find(a => a.id === id);
        if (!article) return;

        currentEditingId = id;
        document.getElementById('articleTitle').value = article.title;
        document.getElementById('articleCategory').value = article.category;
        document.getElementById('articleContent').value = article.content;
        
        // Set image preview if exists
        if (article.imageUrl) {
            articleImageUrl = article.imageUrl;
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.innerHTML = `
                <div class="relative w-full">
                    <img src="${article.imageUrl}" alt="Preview" class="max-h-48 mx-auto rounded-lg">
                    <button type="button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center" 
                            onclick="event.stopPropagation(); document.getElementById('articleImage').value = ''; 
                                     articleImageUrl = ''; 
                                     document.getElementById('imagePreview').innerHTML = `
                                         <div class='text-center'>
                                             <i class='fas fa-image text-4xl text-gray-400 mb-2'></i>
                                             <p class='text-sm text-gray-500'>Klik untuk mengunggah gambar</p>
                                             <p class='text-xs text-gray-400'>Rekomendasi: 800x450px (16:9)</p>
                                         </div>`;">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>`;
        } else {
            articleImageUrl = '';
            document.getElementById('imagePreview').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-image text-4xl text-gray-400 mb-2"></i>
                    <p class="text-sm text-gray-500">Klik untuk mengunggah gambar</p>
                    <p class="text-xs text-gray-400">Rekomendasi: 800x450px (16:9)</p>
                </div>`;
        }
        
        document.getElementById('modalTitle').textContent = 'Edit Artikel';
        document.getElementById('addArticleModal').classList.remove('hidden');
    };

    window.deleteArticle = async function(id) {
        if (confirm('Hapus artikel ini?')) {
            try {
                await deleteDoc(doc(db, COLLECTION_PATH, id));
            } catch (e) { alert('Gagal menghapus'); }
        }
    };

    window.filterarticles = function(category) {
        filteredArticles = category === 'semua' ? [...articles] : articles.filter(a => a.category === category);
        currentPage = 1;
        renderCurrentPage();
        updatePaginationUI();
    };

    async function handleFormSubmit(e) {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        
        // Validate required fields
        const title = document.getElementById('articleTitle').value.trim();
        const category = document.getElementById('articleCategory').value;
        const content = document.getElementById('articleContent').value.trim();
        
        if (!title || !category || !content) {
            alert('Harap isi semua field yang wajib diisi');
            submitBtn.disabled = false;
            return;
        }
        
        if (!articleImageUrl && !currentEditingId) {
            document.getElementById('imageError').textContent = 'Silakan unggah gambar artikel';
            document.getElementById('imageError').classList.remove('hidden');
            submitBtn.disabled = false;
            return;
        }

        const articleData = {
            title: title,
            category: category,
            content: content,
            imageUrl: articleImageUrl || (currentEditingId ? articles.find(a => a.id === currentEditingId)?.imageUrl : ''),
            updatedAt: new Date()
        };

        try {
            if (currentEditingId) {
                await updateDoc(doc(db, COLLECTION_PATH, currentEditingId), articleData);
            } else {
                articleData.createdAt = new Date();
                await addDoc(collection(db, COLLECTION_PATH), articleData);
            }
            
            // Reset form and close modal
            e.target.reset();
            articleImageUrl = '';
            document.getElementById('imagePreview').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-image text-4xl text-gray-400 mb-2"></i>
                    <p class="text-sm text-gray-500">Klik untuk mengunggah gambar</p>
                    <p class="text-xs text-gray-400">Rekomendasi: 800x450px (16:9)</p>
                </div>`;
            document.getElementById('addArticleModal').classList.add('hidden');
            
        } catch (err) {
            console.error('Error saving article:', err);
            alert('Terjadi kesalahan saat menyimpan artikel: ' + err.message);
        } finally {
            submitBtn.disabled = false;
        }
    }

    // --- Helpers ---
    function renderCurrentPage() {
        const start = (currentPage - 1) * itemsPerPage;
        renderArticles(filteredArticles.slice(start, start + itemsPerPage));
    }

    function setupFormHandlers() {
        document.getElementById('addArticleForm').onsubmit = handleFormSubmit;
    }

    function setupModalHandlers() {
        const modal = document.getElementById('addArticleModal');
        
        document.getElementById('addArticleBtn').onclick = () => {
            currentEditingId = null;
            articleImageUrl = '';
            document.getElementById('addArticleForm').reset();
            document.getElementById('imagePreview').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-image text-4xl text-gray-400 mb-2"></i>
                    <p class="text-sm text-gray-500">Klik untuk mengunggah gambar</p>
                    <p class="text-xs text-gray-400">Rekomendasi: 800x450px (16:9)</p>
                </div>`;
            document.getElementById('modalTitle').textContent = 'Tambah Artikel Baru';
            document.getElementById('imageError').classList.add('hidden');
            modal.classList.remove('hidden');
        };
        
        document.getElementById('closeModalBtn').onclick = () => {
            modal.classList.add('hidden');
            document.getElementById('imageError').classList.add('hidden');
        };
        
        // Close modal when clicking outside
        window.onclick = (event) => {
            if (event.target === modal) {
                modal.classList.add('hidden');
                document.getElementById('imageError').classList.add('hidden');
            }
        };
    }

    function setupPagination() {
        document.getElementById('nextPage').onclick = () => {
            if (currentPage * itemsPerPage < filteredArticles.length) {
                currentPage++;
                renderCurrentPage();
                updatePaginationUI();
            }
        };
        document.getElementById('prevPage').onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                renderCurrentPage();
                updatePaginationUI();
            }
        };
    }

    function updatePaginationUI() {
        const totalPages = Math.ceil(filteredArticles.length / itemsPerPage);
        document.getElementById('pageNumbers').innerHTML = `Halaman ${currentPage} dari ${totalPages || 1}`;
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage >= totalPages;
    }

    function initializeSearch() {
        document.getElementById('searchInput').oninput = (e) => {
            const term = e.target.value.toLowerCase();
            filteredArticles = articles.filter(a => a.title.toLowerCase().includes(term));
            currentPage = 1;
            renderCurrentPage();
            updatePaginationUI();
        };
    }

    // Jalankan awal
    setupAuthListener();    
</script>
<script>
    // Toggle dropdown filter
    document.getElementById('filterButton').addEventListener('click', function() {
        const dropdown = document.getElementById('filterDropdown');
        dropdown.classList.toggle('hidden');
    });

    // Tutup dropdown saat klik di luar
    document.addEventListener('click', function(event) {
        const filterContainer = document.getElementById('filterContainer');
        if (!filterContainer.contains(event.target)) {
            document.getElementById('filterDropdown').classList.add('hidden');
        }
    });
</script>
</body>
</html>